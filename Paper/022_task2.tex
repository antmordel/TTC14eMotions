%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Task 2}
%\label{sub:task2}

Task 2 consists of extract all couples from a given model, either from Task 1 or IMBd database~\cite{imdbsources}. Two persons are couple whether they played together in at least three movies~\cite{imdbcase}. Once again we present the e-Motions and the Maude solution.

\subsubsection{e-Motions-based solution}

Fig.~\ref{fig:createCouple} shows the \code{createCouple} rule which implements the whole task. \code{Person} objects are shown using square shapes because \code{Person} is an abstract class and it does not have image attached. The \code{createCouple} rule consists of a LHS with a OCL condition, which states \textit{``LHS holds iff there are two persons \code{per1} and \code{per2}, such that the number of movies in the intersection between \code{per1}'s movies and \code{per2}'s movies is greater or equal than 3''}. Moreover, the \code{coupleHasNotBeenCreated} NAC avoids the application of the rule if the couple already exists. 

However, although this solution works, one can notice that the number of matchings in the LHS of the rule is combinatorial. The fact that there are such a large number of matchings makes this solution too inefficient. \todo{add numbers supporting this.}


\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/ruleCouples}
  \caption{\code{createCouple} rule.}\label{fig:createCouple}
\end{figure}

\begin{table}
  \begin{center}
	\begin{tabular}{r r r}
	$N$ & Time (s) & \# Rewrites \\
	\hline
	2 & 0.66 & 524781 \\
	10 & 46.738 & 19453091 \\
	20 & 660.061 & 161741321 \\
	\hline \\
	\end{tabular}
	\caption{e-Motions times for Task 2 First Version.}\label{table:emotionstask1}
	\end{center}
\end{table}

We have implemented another solution in which we limit the number of matchings using the next algorithm:
\begin{enumerate}
  \item We split \code{Person}s and \code{Movie}s into separate configurations.
  \item We fix a \code{Person}.
  \item Given a \code{Person}, we look for all couples.
  \item Whether the current \code{Person} set has been gone over all the other persons, we set the next person, and the current person is move to the resulting collection.
\end{enumerate}

Following this approach the number of persons to match as possible couple decrease. A new concept so-called \code{Collection} is added to the metamodel with its concrete syntax to implement the algorithm above mentioned. Fig.~\ref{fig:areCouples} shows one of the rules specified for this solution,\footnote{The rest of the rules are available at \url{https://github.com/antmordel/ttc14emotions}.} namely those that creates new couples. The box is the concrete syntax for the \code{Collection} concept.

\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/initialRule}
  \caption{\code{initialRule} rule.}\label{fig:initialRule}
\end{figure}

\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/fixPerson}
  \caption{\code{fixPerson} rule.}\label{fig:fixPerson}
\end{figure}

\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/areCouple}
  \caption{\code{doingCouples} rule.}\label{fig:areCouples}
\end{figure}

\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/areNotCouple}
  \caption{\code{doingCouples} rule.}\label{fig:areNotCouples}
\end{figure}

\begin{figure}[htp]
  \centering
  \includegraphics[width=\textwidth]{imgs/nextPerson}
  \caption{\code{nextPerson} rule.}\label{fig:nextPerson}
\end{figure}

\begin{table}
  \begin{center}
	\begin{tabular}{r r r}
	$N$ & Time (s) & \# Rewrites \\
	\hline
	2 & 30.105 & 27725365 \\
	\hline \\
	\end{tabular}
	\caption{e-Motions times for Task 2 Second Version.}\label{table:emotionstask22}
	\end{center}
\end{table}


\subsubsection{Maude-based solution.}

\todo{Otra vez hacemos dos soluciones, la primera solo consta de una regla y la segunda, de los diferentes pasos. Para la primera, se tienen combinaciones de 2 sobre \#Persons matchings, lo que lo hace muy ineficiente. El n√∫mero de reescrituras se debe a las llamadas a intersection. Para la segunda se crea con el mismo procedimiento que el anterior.}

\begin{lstlisting}[caption=\code{createCouples} Maude rule., label=lst:oneRuleCouples]
crl [findCouples] :
 { freshOid(N) findCouples
   < O1 : V1:Person | movies : MS1, Atts1 >
   < O2 : V2:Person | movies : MS2, Atts2 > Conf }
=>
 { freshOid(s(N)) findCouples
   < O1 : V1:Person | movies : MS1, Atts1 >
   < O2 : V2:Person | movies : MS2, Atts2 >
   C Conf }
if | intersection((MS1), (MS2)) | >= 3
 /\ C := < N : Couple | 
           commonMovies : (intersection((MS1), (MS2))),
           p1 : O1, p2 : O2 >
 /\ not coupleInConf(C, Conf) .
\end{lstlisting}

\begin{table}
  \begin{center}
	\begin{tabular}{r r r}
	$N$ & Time (s) & \# Rewrites \\
	\hline
	1 & 0.004 & 8680 \\
	5 & 0.528 & 1343000 \\
	10 & 5.032 & 11020000 \\
	20 & 66.277 & 89276000 \\
	30 & 314.011 & 302568000 \\
	\hline \\
	\end{tabular}
	\caption{Maude times for Task 2 First Version.}\label{table:maudetask21}
	\end{center}
\end{table}

\todo{second version} \todo{el que no se partan los listings lo podemos arreglar al final}

\begin{lstlisting}[caption=\code{doingCouples} Maude rule., label=lst:task2SecondVersion]

rl [doingPairs] :
  <{ none }{ < O1 : V1@Person | movies : MS1, Atts1 >  C1 }{ C2 }{ C3 }
   { < O2 : V2@Person | movies : MS2, Atts2 > }{ freshOid(New) C4 }>
=> 
  <{ none }{ C1 }{ C2 }{ < O1 : V1@Person | movies : MS1, Atts1 > C3 }
   { < O2 : V2@Person | movies : MS2, Atts2 > }
   { if | intersection(MS1, MS2) | >= 3 
     then < New : Couple | p1 : O1, p2 : O2, 
            commonMovies : intersection(MS1, MS2), avgRating : 0.0 >
          freshOid(s New)
     else freshOid(New)
     fi C4 }> .
\end{lstlisting}
He probado lo que dijimos del caso positivo, pero no se tiene practicamente ninguna ganancia.